<ion-toolbar>
  <ion-buttons slot="start">
    <ion-back-button defaultHref="/"></ion-back-button>
  </ion-buttons>
  <ion-title>Scoping Session</ion-title>
</ion-toolbar>

<ion-content>

  <ng-container *ngIf="(uiState$ | async) === 'Loading' || participantState === ParticipantState.CHECKING_PARTICIPANT">

    Loading...

  </ng-container>


  <app-session-access *ngIf="participantState === ParticipantState.PARTICIPANT_INVALID" [sessionLink]="sessionCode" (access)="access($event)">
  </app-session-access>

  <ng-container *ngIf="participantState === ParticipantState.PARTICIPANT_VALIDATED">

    <ng-container *ngIf="(uiState$ | async) !== 'Loading'">

      <ng-container *ngIf="session && session.tasks; else noSession">

        <ng-container *ngIf="!hasVoted && task">
          <app-session-header [session]="session"></app-session-header>
          <app-task-card [task]="task"></app-task-card>
          <app-vote (vote)="vote($event)"></app-vote>
          <p>{{ (task.votes | objKeys).length}} of {{ (session.participants | objKeys).length}}
            votes counted</p>
        </ng-container>

        <ng-container *ngIf="hasVoted && task">
          <app-session-header [session]="session"></app-session-header>
          <app-task-card [task]="task" [onlyTitle]="true"></app-task-card>
          <app-result-estimate *ngIf="task.estimate" [estimate]="task.estimate"></app-result-estimate>
          <ng-container *ngIf="isModerator && !task.estimate">
            <app-select-result
              [avg]="_.mean(task.votes | objValues)"
              [max]="_.max(task.votes | objValues)"
              (estimate)="setFinalEstimate($event)"></app-select-result>
          </ng-container>
          <app-counted-votes [votes]="task.votes" [participantCount]="(session.participants | objKeys).length"></app-counted-votes>

          <ng-container *ngIf="!task.estimate">
            <ion-footer *ngIf="!isModerator">
              <ion-toolbar>
                <ion-title>Waiting</ion-title>
              </ion-toolbar>
            </ion-footer>
            <ion-footer *ngIf="isModerator">
              <ion-toolbar>
                <ion-button [disabled]="!finalEstimate" (click)="saveFinalEstimate()">Submit</ion-button>
              </ion-toolbar>
            </ion-footer>
          </ng-container>
          <ng-container *ngIf="task.estimate">
            <ion-footer>
              <ion-toolbar>
                <ion-button (click)="nextTask()">Next task</ion-button>
              </ion-toolbar>
            </ion-footer>
          </ng-container>
        </ng-container>
      </ng-container>

      <ng-template #noSession>
        No session found
      </ng-template>

    </ng-container>
  </ng-container>


</ion-content>
